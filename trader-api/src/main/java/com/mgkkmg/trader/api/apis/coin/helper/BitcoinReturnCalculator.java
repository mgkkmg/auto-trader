package com.mgkkmg.trader.api.apis.coin.helper;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

public class BitcoinReturnCalculator {

	static class Transaction {
		String decision;
		double percentage;
		double btcPrice;
		double avgBuyPrice;
		double krwBalance;
		double btcBalance;
		Date createdAt;

		public Transaction(String[] data) throws Exception {
			this.decision = data[0];
			this.percentage = Double.parseDouble(data[1]);
			this.btcPrice = Double.parseDouble(data[2]);
			this.avgBuyPrice = Double.parseDouble(data[3]);
			this.krwBalance = Double.parseDouble(data[4]);
			this.btcBalance = Double.parseDouble(data[5]);
			SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSSSSS");
			this.createdAt = sdf.parse(data[6]);
		}
	}

	public static void main(String[] args) throws Exception {
		String data = "decision,percentage,btc_krw_price,btc_avg_buy_price,krw_balance,btc_balance,created_at\n" +
			"buy,75,85000000,84937000,4375.72527488,0.00036024,2024-10-13 00:00:27.534337\n" +
			"hold,0,84902000,84968271.81878748,4375.72527488,0.00036024,2024-10-13 03:00:31.617754\n" +
			"hold,0,85021000,84968271.81878748,4375.72527488,0.00036024,2024-10-13 09:00:34.668423\n" +
			"hold,0,84688000,84968271.81878748,4375.72527488,0.00036024,2024-10-13 12:00:26.499336\n" +
			"buy,50,84660000,84968271.81878748,19688.04705523,0.00059266,2024-10-13 14:00:30.909050\n" +
			"buy,20,84811000,84849339.48638342,14685.938801,0.00065161,2024-10-13 16:00:24.313198\n" +
			"hold,0,84730000,84845870.98110833,14685.938801,0.00065161,2024-10-13 18:00:24.987192\n" +
			"hold,0,84640000,84845870.98110833,14685.938801,0.00065161,2024-10-13 20:00:30.911593\n" +
			"hold,0,84541000,84845870.98110833,14685.938801,0.00065161,2024-10-13 22:00:28.815004\n" +
			"hold,0,83942000,84845870.98110833,14685.938801,0.00065161,2024-10-14 00:00:23.472441\n" +
			"hold,0,84580000,84845870.98110833,14685.938801,0.00065161,2024-10-14 02:00:21.944082\n" +
			"hold,0,84778000,84845870.98110833,14685.938801,0.00065161,2024-10-14 08:00:25.597564\n" +
			"hold,0,84416000,84845870.98110833,14685.938801,0.00065161,2024-10-14 10:00:25.378694\n" +
			"hold,0,84680000,84845870.98110833,14685.938801,0.00065161,2024-10-14 12:00:34.840640\n" +
			"buy,30,86311000,84845870.98110833,9683.438801,0.00065161,2024-10-14 14:00:45.999044\n" +
			"buy,20,86389000,84965490.62773064,4680.94257289,0.00070954,2024-10-14 16:00:49.916766\n" +
			"hold,0,86788000,85072836.74958627,4681.61147717,0.00076741,2024-10-14 18:00:36.677000\n" +
			"hold,0,87576000,85072836.74958627,4681.61147717,0.00076741,2024-10-14 23:00:40.872971\n" +
			"sell,50,88102000,85072836.74958627,4681.61147717,0.0003837,2024-10-15 03:01:02.083536\n" +
			"sell,50,88496000,85072836.74958627,38444.2478541,0.00019185,2024-10-15 21:00:32.973952\n" +
			"buy,30,90190000,85072836.74958627,38789.0732418,0.00037607,2024-10-16 03:00:27.892851\n" +
			"hold,0,90117000,87579507.88525574,38789.0732418,0.00037607,2024-10-16 06:00:27.844689\n" +
			"hold,0,90572000,87579507.88525574,38789.0732418,0.00037607,2024-10-16 09:00:40.864298\n" +
			"buy,30,91175000,87579507.88525574,27153.2582418,0.00037607,2024-10-16 12:00:37.262087\n" +
			"hold,0,90880000,88490378.32176666,27153.7596924,0.00050362,2024-10-16 15:00:27.874406\n" +
			"sell,50,90834000,88490378.32176666,27153.7596924,0.00025181,2024-10-16 18:00:24.631059\n" +
			"buy,30,91784000,88490378.32176666,35010.73427763,0.00025181,2024-10-16 21:00:42.323281\n" +
			"buy,30,91501000,89786488.259162,24508.54404675,0.00052985,2024-10-17 00:00:34.395505\n" +
			"hold,0,92058000,90170244.26763058,124508.54404675,0.00052985,2024-10-17 03:00:31.004871\n" +
			"buy,30,91497000,90170244.26763058,87156.87754675,0.00093787,2024-10-17 06:00:38.829176\n" +
			"buy,30,91619000,90747448.86306638,61010.20480378,0.00093787,2024-10-17 09:00:44.086601\n" +
			"buy,20,91500000,90950464.23069394,48808.99480756,0.00122311,2024-10-17 12:00:39.908346\n" +
			"buy,20,91400000,91004560.32940678,39047.86340092,0.00146314,2024-10-17 15:00:31.564129\n" +
			"hold,0,91961000,91033411.42009928,39047.91342592,0.00146314,2024-10-17 18:00:24.851986\n" +
			"hold,0,91294000,91033411.42009928,39047.91342592,0.00146314,2024-10-17 21:00:31.038085\n" +
			"buy,25,91570000,91033411.42009928,29286.03492592,0.00146314,2024-10-18 00:00:25.021663\n" +
			"buy,30,91811000,91069834.86242765,20500.86103417,0.00156969,2024-10-18 03:00:30.844685\n" +
			"hold,0,91429000,91112400.01993843,20501.05709215,0.00166533,2024-10-18 06:00:43.138486\n" +
			"hold,0,91758000,91112400.01993843,20501.05709215,0.00166533,2024-10-18 09:00:38.031446\n" +
			"buy,30,92418000,91112400.01993843,14350.98359215,0.00166533,2024-10-18 12:00:26.853461\n" +
			"buy,30,92428000,91162540.59566938,9348.76255156,0.00173184,2024-10-18 15:00:21.739536\n" +
			"buy,100,92503000,91200988.38431745,0.44384812,0.00178593,2024-10-18 18:00:26.155623\n" +
			"hold,0,92501000,91270686.51637257,0.71595411,0.00188694,2024-10-18 21:00:28.940298\n" +
			"hold,0,93134000,91270686.51637257,0.71595411,0.00188694,2024-10-19 00:00:28.375330\n" +
			"sell,30,93385000,91270686.51637257,52829.17810931,0.00132086,2024-10-19 03:00:27.112950\n" +
			"buy,30,93267000,91270686.51637257,36981.25810931,0.00132086,2024-10-19 06:00:21.444559\n" +
			"sell,50,93370000,91498120.7373873,36981.723732,0.00074534,2024-10-19 09:00:44.339485\n" +
			"hold,0,93212000,91498120.7373873,106531.31683935,0.00074534,2024-10-19 12:00:30.738795\n" +
			"hold,0,91905000,91498120.7373873,106531.31683935,0.00074534,2024-10-22 00:00:39.086754\n" +
			"buy,30,92388000,91780104.5114971,74573.11860579,0.00109108,2024-10-22 04:00:32.626493\n" +
			"buy,30,92723000,91780104.5114971,52201.93860579,0.00109108,2024-10-22 08:00:44.189051\n" +
			"hold,0,92287000,91954726.85948809,52202.04660977,0.00133217,2024-10-22 12:00:37.604391\n" +
			"buy,30,92668000,91954726.85948809,36542.22060977,0.00133217,2024-10-22 16:00:29.639957\n" +
			"buy,30,92449000,92034984.16489854,25580.11709717,0.00150107,2024-10-22 20:00:31.225763\n" +
			"hold,0,92777000,92065061.89863129,325580.41732721,0.00161959,2024-10-23 00:00:34.024459\n" +
			"hold,0,92596000,92065061.89863129,325580.41732721,0.00161959,2024-10-23 04:00:32.260178\n" +
			"hold,0,93299000,92065061.89863129,325580.41732721,0.00161959,2024-10-23 08:00:31.279464\n" +
			"hold,0,92594000,92065061.89863129,325580.41732721,0.00161959,2024-10-23 12:00:40.581317\n" +
			"sell,50,92479000,92065061.89863129,400419.60969187,0.00080979,2024-10-23 16:00:41.824660\n" +
			"sell,50,91892000,92065061.89863129,400419.60969187,0.00040489,2024-10-23 20:00:34.313592\n" +
			"sell,30,91979000,92065061.89863129,437608.07695647,0.00028342,2024-10-24 00:00:33.234919\n" +
			"sell,50,91752000,92065061.89863129,448775.05833264,0.00014171,2024-10-24 04:00:34.313592\n" +
			"hold,0,92143000,92065061.89863129,461770.73316468,0.00014171,2024-10-24 08:00:29.164671\n" +
			"sell,50,93192000,92065061.89863129,461770.73316468,0.00007085,2024-10-24 12:00:29.703975\n" +
			"hold,0,92850000,92065061.89863129,468365.56300023,0.00007085,2024-10-24 20:00:45.865167\n";

		List<Transaction> transactions = new ArrayList<>();
		String[] lines = data.split("\n");
		for (int i = 1; i < lines.length; i++) { // 헤더를 건너뜁니다.
			String[] cols = lines[i].split(",");
			transactions.add(new Transaction(cols));
		}

		double initialKRW = transactions.get(0).krwBalance;
		double initialBTCValue = transactions.get(0).btcBalance * transactions.get(0).btcPrice;
		double initialTotal = initialKRW + initialBTCValue;

		double totalDeposits = 0;
		double totalWithdrawals = 0;

		for (int i = 1; i < transactions.size(); i++) {
			Transaction prev = transactions.get(i - 1);
			Transaction curr = transactions.get(i);

			double btcChange = curr.btcBalance - prev.btcBalance;
			double btcPrice = curr.btcPrice;

			double expectedKRWBalance = prev.krwBalance - btcChange * btcPrice;
			double actualKRWBalance = curr.krwBalance;
			double krwDifference = actualKRWBalance - expectedKRWBalance;

			if (Math.abs(krwDifference) > 1) { // 입출금으로 간주되는 임계값
				if (krwDifference > 0) {
					totalDeposits += krwDifference;
				} else {
					totalWithdrawals += -krwDifference;
				}
			}
		}

		Transaction lastTransaction = transactions.get(transactions.size() - 1);
		double finalKRW = lastTransaction.krwBalance;
		double finalBTCValue = lastTransaction.btcBalance * lastTransaction.btcPrice;
		double finalTotal = finalKRW + finalBTCValue;

		double netInvestment = initialTotal + totalDeposits - totalWithdrawals;
		double profit = finalTotal - netInvestment;
		double cumulativeReturn = (profit / netInvestment) * 100;

		System.out.printf("기간 누적 수익률: %.2f%%\n", cumulativeReturn);
	}
}
